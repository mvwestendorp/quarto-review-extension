# Skipped Tests Analysis

This document analyzes all skipped tests to determine whether they represent:
1. **Implementation Issues** - Bugs that need to be fixed
2. **Test Issues** - Tests that are incorrectly written
3. **Known Limitations** - Expected behavior that can't be changed

## Summary

- **Total Skipped**: 30 tests
- **Implementation Issues**: 8 tests (segment preprocessor)
- **Test Issues**: 3 tests (fixture tests with incorrect expectations)
- **Known Limitations**: 2 tests (diff algorithm artifacts)

## Detailed Analysis

### 1. Fixture-Based Tests (5 skipped)

#### comments-inline
**Location**: `tests/unit/core/transformation-pipeline.test.ts` and `tests/integration/transformation-pipeline-integration.test.ts`
**Status**: ❌ **TEST ISSUE - Should be removed or redesigned**

**Problem**: The fixture expects the "edit" to contain CriticMarkup syntax `{>>comment<<}`, but:
- Users don't type CriticMarkup - it's generated by the diff algorithm
- The diff algorithm sees `{>>comment<<}` as literal text, not as a comment marker
- The expected output `{++{>>comment<<}++}` shows the comment wrapped in additions

**Verdict**: This test is testing an invalid use case. CriticMarkup is OUTPUT, not INPUT.

**Recommendation**:
- Remove this fixture OR
- Change it to test actual comment functionality (if comments can be added separately from the diff)

---

#### list-delete-item
**Location**: `tests/unit/core/transformation-pipeline.test.ts` and `tests/integration/transformation-pipeline-integration.test.ts`
**Status**: ⚠️ **KNOWN LIMITATION**

**Problem**: When deleting a list item, the diff algorithm generates:
```markdown
- First item
- {--Second item--}
- Third item
```

When accepting changes, this becomes:
```markdown
- First item
-
- Third item
```

An empty list item remains instead of the line being removed entirely.

**Verdict**: This is a fundamental limitation of line-based diffing. The algorithm doesn't understand markdown structure.

**Recommendation**:
- Keep skipped OR
- Update the expected "accepted" output to match the actual behavior (with empty list item)
- Add documentation explaining this limitation

---

#### mixed-changes-and-comments
**Location**: `tests/unit/core/transformation-pipeline.test.ts` and `tests/integration/transformation-pipeline-integration.test.ts`
**Status**: ❌ **TEST ISSUE - Same as comments-inline**

**Problem**: Same issue as `comments-inline` - expects CriticMarkup in the edit input.

**Verdict**: Invalid test case.

**Recommendation**: Remove this fixture.

---

### 2. Complex Content Tests (2 skipped)

#### "should handle document with headings, lists, and tables"
**Location**: `tests/integration/transformation-pipeline-integration.test.ts:181`
**Status**: ⚠️ **KNOWN LIMITATION - Trailing spaces**

**Problem**: The diff algorithm adds trailing spaces to unchanged lines near modified content.

**Input**: `# Main Heading`
**Output after roundtrip**: `# Main Heading `

**Verdict**: This is an artifact of the diff algorithm's line processing.

**Recommendation**:
- Keep skipped OR
- Update test to use `.replace(/\s+$/gm, '')` to strip trailing spaces before comparison
- Document this as expected behavior

---

#### "should handle documents with mixed elements"
**Location**: `tests/unit/core/transformation-pipeline.test.ts:333`
**Status**: ⚠️ **KNOWN LIMITATION - Trailing spaces**

**Problem**: Same as above.

**Recommendation**: Same as above.

---

### 3. Segment Preprocessor Tests (8 skipped)

#### "should handle caption without colon (fallback)"
**Location**: `tests/unit/modules/segment-preprocessor.test.ts:194`
**Status**: ⚠️ **IMPLEMENTATION ISSUE** or **TEST ISSUE**

**Problem**: Test expects caption kind detection to work without a colon (e.g., "Figure caption text" instead of "Figure: caption text").

**To Verify**:
1. Check if the implementation actually supports colon-less captions
2. If yes, fix the DOM structure in the test
3. If no, remove the test or mark as future enhancement

**Recommendation**: Verify actual Quarto HTML output to see if colon-less captions exist.

---

#### "should generate sequential IDs for multiple tables"
**Location**: `tests/unit/modules/segment-preprocessor.test.ts:374`
**Status**: ❓ **NEEDS VERIFICATION**

**Problem**: Test expects sequential table IDs (tablecap-1, tablecap-2), but implementation may not be tracking counters correctly.

**To Verify**: Run the test with logging to see what IDs are actually generated.

**Recommendation**: Debug to see if this is a real bug or DOM structure mismatch.

---

#### "should handle table caption without colon"
**Location**: `tests/unit/modules/segment-preprocessor.test.ts:397`
**Status**: ⚠️ **IMPLEMENTATION ISSUE** or **TEST ISSUE**

**Problem**: Similar to figure caption without colon.

**Recommendation**: Check if table captions need colons in Quarto.

---

#### "should detect figure from container class 'quarto-figure-center'"
**Location**: `tests/unit/modules/segment-preprocessor.test.ts:430`
**Status**: ❓ **NEEDS VERIFICATION**

**Problem**: Test expects `quarto-figure-center` to be detected as a figure container, but implementation may only check for `quarto-figure`.

**To Verify**: Check the actual implementation of container detection.

**Recommendation**:
- If this is a valid Quarto class, fix the implementation
- If not, remove the test

---

#### "should detect table from container class 'quarto-table'"
**Location**: `tests/unit/modules/segment-preprocessor.test.ts:457`
**Status**: ❓ **NEEDS VERIFICATION**

**Problem**: Implementation may not detect table containers correctly.

**Recommendation**: Verify actual Quarto HTML structure for tables.

---

#### "should detect table from caption class 'quarto-float-table'"
**Location**: `tests/unit/modules/segment-preprocessor.test.ts:471`
**Status**: ❓ **NEEDS VERIFICATION**

**Problem**: Implementation may not detect table captions by class.

**Recommendation**: Verify detection logic.

---

#### "should handle document with both title and captions"
**Location**: `tests/unit/modules/segment-preprocessor.test.ts:511`
**Status**: ❓ **NEEDS VERIFICATION**

**Problem**: May be a compound failure of the above issues.

**Recommendation**: Fix individual issues first, then revisit.

---

#### "should handle multiple figures and tables with correct counters"
**Location**: `tests/unit/modules/segment-preprocessor.test.ts:534`
**Status**: ❓ **NEEDS VERIFICATION**

**Problem**: Counter tracking may have bugs.

**Recommendation**: Debug counter logic.

---

## Recommendations Summary

### Immediate Actions:

1. **Remove invalid fixtures**:
   - `comments-inline`
   - `mixed-changes-and-comments`

2. **Document known limitations**:
   - List deletion leaving empty items
   - Trailing spaces from diff algorithm

3. **Investigate segment preprocessor** (Priority: High):
   - Read actual Quarto HTML to understand expected DOM structure
   - Check container/caption detection logic
   - Fix counter tracking
   - Update tests to match actual Quarto output

### Test Count After Cleanup:

- **Remove**: 2 tests (invalid fixtures)
- **Keep Skipped**: 2 tests (known limitations with documentation)
- **Investigate**: 8 tests (segment preprocessor - likely real bugs)

**Expected Result**: ~20-22 tests either fixed or properly documented as limitations.
